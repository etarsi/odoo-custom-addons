<odoo>
    <!-- Acción de reporte -->
    <report
        id="report_debt_composition_client_company_pdf"
        model="report.debt.composition.client.company"
        string="Composición de deuda"
        report_type="qweb-pdf"
        name="debt_composition.report_debt_composition_client_company_pdf_template"
        file="debt_composition.report_debt_composition_client_company_pdf_template"
    />

    <!-- Plantilla QWeb -->
    <template id="report_debt_composition_client_company_pdf_template">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <t t-set="doc" t-value="docs and docs[0] or False"/>
                <div class="page">
                    <h2>COMPOSICIÓN DE DEUDA</h2>
                    <t t-if="doc">
                        <p>
                            <strong>Cliente: </strong>
                            <t t-esc="doc.partner and doc.partner.name or ''"/>
                        </p>
                    </t>
                    <table class="table table-sm o_main_table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Comprobante</th>
                                <th>Importe original</th>
                                <th>Aplicado</th>
                                <th>Saldo</th>
                                <th>Saldo acumulado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-set="current_company" t-value="False"/>
                            <t t-set="last_saldo_company" t-value="0.0"/>
                            <t t-set="grand_total_saldo" t-value="0.0"/>

                            <t t-foreach="docs" t-as="l">
                                <t t-if="current_company and l.company_id != current_company">
                                    <tr>
                                        <td colspan="6" class="text-right">
                                            <strong>Saldo <t t-esc="current_company.name"/>:</strong>
                                        </td>
                                        <td class="text-right">
                                            <strong>
                                                <span t-esc="'%s %s' % (
                                                    (docs and docs[0].currency_id and docs[0].currency_id.symbol or ''),
                                                    ('{0:,.2f}'.format(last_saldo_company or 0.0))
                                                )"/>
                                            </strong>
                                        </td>
                                    </tr>
                                    <t t-set="grand_total_saldo" t-value="grand_total_saldo + (last_saldo_company or 0.0)"/>
                                    <t t-set="last_saldo_company" t-value="0.0"/>
                                </t>
                                <t t-if="not current_company or l.company_id != current_company">
                                    <tr>
                                        <td colspan="7">
                                            <strong>
                                                Compañía:
                                                <t t-esc="l.company_id and l.company_id.name or ''"/>
                                            </strong>
                                        </td>
                                    </tr>
                                    <t t-set="current_company" t-value="l.company_id"/>
                                </t>
                                <!-- Detalle de la línea -->
                                <tr>
                                    <td>
                                        <span t-field="l.fecha" t-options='{"widget": "date"}'/>
                                    </td>
                                    <td><t t-esc="l.nombre"/></td>
                                    <td class="text-right">
                                        <span t-field="l.importe_original"/>
                                    </td>
                                    <td class="text-right">
                                        <span t-field="l.importe_aplicado"/>
                                    </td>
                                    <td class="text-right">
                                        <span t-field="l.importe_residual"/>
                                    </td>
                                    <td class="text-right">
                                        <span t-field="l.saldo_acumulado"/>
                                    </td>
                                </tr>
                                <t t-set="last_saldo_company" t-value="l.saldo_acumulado or 0.0"/>
                            </t>
                            <t t-if="current_company">
                                <tr>
                                    <td colspan="6" class="text-right">
                                        <strong>Saldo <t t-esc="current_company.name"/>:</strong>
                                    </td>
                                    <td class="text-right">
                                        <strong>
                                            <span t-esc="'%s %s' % (
                                                (docs and docs[0].currency_id and docs[0].currency_id.symbol or ''),
                                                ('{0:,.2f}'.format(last_saldo_company or 0.0))
                                            )"/>
                                        </strong>
                                    </td>
                                </tr>
                                <t t-set="grand_total_saldo"
                                t-value="grand_total_saldo + (last_saldo_company or 0.0)"/>
                            </t>
                            <tr>
                                <td colspan="7" style="height: 15px;"></td>
                            </tr>
                            <tr>
                                <td colspan="5" class="text-right" style="font-size:20px;">
                                    <strong>Saldo Total:</strong>
                                </td>
                                <td colspan="2" class="text-right" style="font-size:20px;">
                                    <strong>
                                        <span t-esc="'%s %s' % (
                                            (docs and docs[0].currency_id and docs[0].currency_id.symbol or ''),
                                            ('{0:,.2f}'.format(grand_total_saldo or 0.0))
                                        )"/>
                                    </strong>
                                </td>
                            </tr>
                        </tbody>

                    </table>
                </div>
            </t>
        </t>
    </template>
</odoo>
