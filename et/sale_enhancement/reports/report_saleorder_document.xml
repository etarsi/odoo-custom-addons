<?xml version="1.0" encoding="utf-8"?>
<odoo>  
  <template id="report_saleorder_document_enhancement" inherit_id="sale.report_saleorder_document">
    <!-- 1) Quitar el forced_vat -->
    <xpath expr="//t[@t-set='forced_vat']" position="replace">
      <t t-set="forced_vat" t-value="False"/>
    </xpath>

    <!-- 2) Vaciar el bloque address (header) -->
    <xpath expr="//t[@t-set='address']" position="replace">
      <t t-set="address" t-value="''"/>
    </xpath>

    <!-- 3) Vaciar el bloque information_block -->
    <xpath expr="//t[@t-set='information_block']" position="replace">
      <t t-set="information_block" t-value="''"/>
    </xpath>

    <!-- 4) -->
    <xpath expr="//div[@id='informations']" position="replace">
      <div id="informations" class="mt8 mb8" style="width:100%;">

        <div style="width:50%; float:left; box-sizing:border-box; padding-right:10px;">
          <strong>Cliente: </strong><span t-field="doc.partner_id"/>
          <br/>
          <t t-if="doc.partner_id.vat">
            <strong>CUIT: </strong><span t-field="doc.partner_id.vat"/>
            <br/>
          </t>
          <t t-if="doc.payment_term_id">
            <strong>Plazos de Pago: </strong>
            <span t-field="doc.payment_term_id"/>
            <br/>
          </t>
        </div>

        <div style="width:50%; float:left; box-sizing:border-box; padding-left:10px;">
          <strong>Fecha Presupuesto: </strong>
          <span t-field="doc.date_order"/>
          <br/>
          <!--
            <t t-if="doc.user_id">
              <strong>Comercial: </strong>
              <span t-field="doc.user_id"/>
              <br/>
            </t>
          -->
          <t t-if="doc.partner_shipping_id">
            <strong>Dirección de Entrega: </strong>
            <span t-field="doc.partner_shipping_id"/>
          </t>
        </div>
        <div style="clear:both;"></div>
      </div>
    </xpath>

    <!-- heredar la table -->
    <xpath expr="//table[@class='table table-sm o_main_table']" position="replace">
      <t t-set="display_discount" t-value="any(l.discount for l in doc.order_line)"/>
      <table class="table table-sm o_main_table">
          <!-- In case we want to repeat the header, remove "display: table-row-group" -->
          <thead style="display: table-row-group">
              <tr>
                  <th name="th_code" class="text-left">Código</th>
                  <th name="th_description" class="text-left">Descripción</th>
                  <th name="th_quantity" class="text-right">Unidades</th>
                  <th name="th_priceunit" class="text-right">Precio Unitario</th>
                  <th name="th_discount" t-if="display_discount" class="text-right"><span>Desc.%</span></th>
                  <th name="th_subtotal" class="text-right">
                      <span groups="account.group_show_line_subtotals_tax_excluded">Importe</span>
                      <span groups="account.group_show_line_subtotals_tax_included">Precio Total</span>
                  </th>
              </tr>
          </thead>
          <tbody class="sale_tbody">
              <t t-set="current_section" t-value="False"/>
              <t t-set="current_subtotal" t-value="0"/>
              <t t-foreach="doc.order_line" t-as="line">
                  <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                  <t t-set="current_subtotal" t-value="current_subtotal + line.price_total" groups="account.group_show_line_subtotals_tax_included"/>
                  <tr t-att-class="'bg-200 font-weight-bold o_line_section' if line.display_type == 'line_section' else 'font-italic o_line_note' if line.display_type == 'line_note' else ''">
                      <t t-if="not line.display_type">
                          <td name="td_code"><span t-field="line.product_id.default_code"/></td>
                          <td name="td_name" style="font-size: 12px;"><span t-field="line.product_id.name"/></td>
                          <td name="td_quantity" class="text-right">
                              <span t-field="line.product_uom_qty" t-options='{"widget": "float", "precision": 0}'/>
                          </td>
                          <td name="td_priceunit" class="text-right">
                              <span t-field="line.price_unit"/>
                          </td>
                          <td class="text-right" t-if="display_discount" name="td_discount">
                              <span t-field="line.discount"/>
                          </td>
                          <td name="td_subtotal" class="text-right o_price_total">
                              <span t-field="line.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                              <span t-field="line.price_total" groups="account.group_show_line_subtotals_tax_included"/>
                          </td>
                      </t>
                      <t t-if="line.display_type == 'line_section'">
                          <td name="td_section_line" colspan="99">
                              <span t-field="line.name"/>
                          </td>
                          <t t-set="current_section" t-value="line"/>
                          <t t-set="current_subtotal" t-value="0"/>
                      </t>
                      <t t-if="line.display_type == 'line_note'">
                          <td name="td_note_line" colspan="99">
                              <span t-field="line.name"/>
                          </td>
                      </t>
                  </tr>
                  <t t-if="current_section and (line_last or doc.order_line[line_index+1].display_type == 'line_section')">
                      <tr class="is-subtotal text-right">
                          <td name="td_section_subtotal" colspan="99">
                              <strong class="mr16">Subtotal</strong>
                              <span t-esc="current_subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/>
                          </td>
                      </tr>
                  </t>
              </t>
          </tbody>
      </table>
    </xpath>

    <xpath expr="//div[@name='so_total_summary']//div[@name='total']//table" position="replace">
      <table class="table table-sm">
        <t t-set="lines" t-value="doc.order_line.filtered(lambda l: not l.display_type)"/>
        <t t-set="amount_wo_discount" t-value="sum([(l.product_uom_qty or 0.0) * (l.price_unit or 0.0) for l in lines])"/>
        <t t-set="discount_amount" t-value="sum([((l.product_uom_qty or 0.0) * (l.price_unit or 0.0)) * ((l.discount or 0.0) / 100.0) for l in lines])"/>
        <t t-set="discount_percent" t-value="(discount_amount / amount_wo_discount * 100.0) if amount_wo_discount else 0.0"/>
        <t t-if="discount_amount">
          <tr>
            <td class="text-right" t-if="display_discount">
              <strong>Total sin Descuento</strong>
            </td>
            <td class="text-right" t-if="display_discount">
              <span t-esc="amount_wo_discount" t-options="{'widget':'monetary','display_currency': doc.currency_id}"/>
            </td>
          </tr>
          <tr>
            <td class="text-right" t-if="display_discount">
              <strong>Descuento <t t-esc="(' %.1f' % discount_percent) + ' %'"/></strong>
            </td>
            <td class="text-right" t-if="display_discount">
              <span t-esc="discount_amount" t-options="{'widget':'monetary','display_currency': doc.currency_id}"/>
            </td>
          </tr>
        </t>
        <t t-set="tax_totals" t-value="json.loads(doc.tax_totals_json)"/>
        <t t-call="account.document_tax_totals"/>
      </table>
    </xpath>
  </template>
</odoo>
