<?xml version='1.0' encoding='utf-8'?>
<odoo>
    <data>
        <template id="report_payment_group_document_enhancement" name="Account Payment Group Document Enhancement" inherit_id="l10n_ar_ux.report_payment_group_document">
            <xpath expr="//table[@name='matching_table']" position="replace">
                <!-- tamaÃ±o de letra  -->
                <table class="table table-sm o_main_table" name="matching_table" style="width: 100%; border-collapse: collapse; border: 1px solid #dfe3e8; margin-bottom: 1.5rem; font-size: 9px;">
                    <thead>
                        <tr>
                            <th><span>Comprobantes Imputados</span></th>
                            <th class="text-center"><span>Fecha Venc.</span></th>
                            <th class="text-right"><span>Importe Original</span></th>
                            <th class="text-right"><span>Importe Imputado</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-set="seen_move_ids" t-value="[]"/>
                        <t t-foreach="o.with_context(payment_group_id=o.id).matched_move_line_ids" t-as="line">
                            <tr>
                                <td><span t-field="line.move_id.display_name"/></td>
                                <td class="text-center">
                                    <span class="text-nowrap" t-field="line.date_maturity"/>
                                </td>
                                <td class="text-right o_price_total">
                                    <span class="text-nowrap" t-raw="(o.partner_type == 'supplier' and -1.0 or 1.0) * line.balance" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                                </td>
                                <td class="text-right o_price_total">
                                    <span class="text-nowrap" t-raw="(o.partner_type == 'supplier' and -1.0 or 1.0) * line.payment_group_matched_amount" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                                </td>
                            </tr>
                            <t t-set="seen_move_ids" t-value="seen_move_ids + [line.move_id.id]"/>
                            <t t-if="line.full_reconcile_id">
                                <t t-foreach="line.full_reconcile_id.reconciled_line_ids" t-as="reconciled_line">
                                <t t-if="('FA' in reconciled_line.move_id.display_name and reconciled_line.payment_group_matched_amount==0 or 'NC' in reconciled_line.move_id.display_name) and reconciled_line.move_id.id not in seen_move_ids">
                                    <t t-set="seen_move_ids" t-value="seen_move_ids + [reconciled_line.move_id.id]"/>
                                    <tr>
                                    <td><span t-field="reconciled_line.move_id.display_name"/></td>
                                    <td class="text-center">
                                        <span class="text-nowrap" t-field="reconciled_line.date_maturity"/>
                                    </td>
                                    <td class="text-right o_price_total">
                                        <span class="text-nowrap" t-raw="(o.partner_type == 'supplier' and -1.0 or 1.0) * reconciled_line.balance" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                                    </td>
                                    <td class="text-right o_price_total">
                                        <span class="text-nowrap" t-raw="(o.partner_type == 'supplier' and -1.0 or 1.0) * reconciled_line.payment_group_matched_amount" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                                    </td>
                                    </tr>
                                    </t>
                            </t>
                            </t>
                            <t t-foreach="o.env['account.move'].search([('reversed_entry_id', '=', line.move_id.id),('state','=','posted')])" t-as="reversed_move">
                            <t t-if="reversed_move">
                                    <tr>
                                        <td><span t-field="reversed_move.display_name"/></td>
                                        <td class="text-center">
                                            <span class="text-nowrap" t-field="reversed_move.invoice_date_due"/>
                                        </td>
                                        <td class="text-right o_price_total">
                                            <span class="text-nowrap" t-raw="(o.partner_type == 'supplier' and 1.0 or -1.0) * reversed_move.amount_total" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                                        </td>
                                        <td class="text-right o_price_total">
                                            <span class="text-nowrap" t-raw="(o.partner_type == 'supplier' and 1.0 or -1.0) * reversed_move.amount_residual" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                                        </td>
                                    </tr>
                            </t>
                            </t>

                        </t>
                        <tr t-if="o.unmatched_amount">
                            <td>A cuenta</td>
                            <td class="text-center"/>
                            <td class="text-right o_price_total"/>
                            <td class="text-right o_price_total">
                                <span class="text-nowrap" t-field="o.unmatched_amount"/>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong><span>Total Imputado</span></strong></td>
                            <td class="text-right">
                                <strong><span class="text-nowrap" t-raw="o.unmatched_amount + o.matched_amount" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/></strong>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </xpath>
        </template>    
    </data>
</odoo>